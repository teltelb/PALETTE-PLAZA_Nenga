<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>年賀状 見積（GitHub Pages 版 / フル計算対応）</title>
    <!-- TailwindCSS CDN: ビルド不要でGitHub Pages向け -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            boxShadow: {
              soft: "0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06)",
            },
            borderRadius: {
              '2xl': '1rem'
            }
          },
        },
      };
    </script>
    <style>
      .thin-scroll::-webkit-scrollbar { height: 8px; }
      .thin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
      .thin-scroll::-webkit-scrollbar-track { background: transparent; }
      .pill { display:inline-flex; align-items:center; gap:.5rem; border-radius:9999px; background:#f1f5f9; padding:.25rem .75rem; font-size:12px; color:#475569; }
    </style>
  </head>
  <body class="min-h-screen w-full bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
    <main class="mx-auto max-w-[1024px] px-5 py-8">
      <section class="rounded-2xl border border-slate-200 bg-white/70 shadow-soft backdrop-blur">
        <header class="flex items-center justify-between gap-4 border-b border-slate-100 p-5">
          <h1 class="text-xl font-semibold tracking-tight">年賀状 料金入力（GitHub Pages版）</h1>
          <span class="text-sm text-slate-500">フル計算（印刷代/はがき/宛名/各オプション/クーポン/納期加算）</span>
        </header>

        <div class="p-5">
          <!-- 1行目 -->
          <div class="grid grid-cols-12 gap-4">
            <!-- 絵柄（コード） -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">絵柄</label>
              <select id="artwork" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">選択してください</option>
                <!-- ハイグレード★★★★ -->
                <option>PHG</option><option>DN</option><option>ZN</option><option>RN</option><option>UN</option><option>SN</option><option>LN</option>
                <!-- プレミアム★★★ -->
                <option>PPR</option><option>DO</option><option>ZO</option><option>UO</option><option>BN</option>
                <!-- スタンダード★★ -->
                <option>PSD</option><option>BO</option>
                <!-- ライト★ -->
                <option>PLT</option>
                <!-- MYデザイン -->
                <option>MY</option>
              </select>
              <p class="mt-1 text-xs text-slate-400">2〜3文字コード（例：PHG, PPR, PSD, PLT, MY）</p>
            </div>

            <!-- 仕上がり -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">仕上がり</label>
              <select id="finish" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">選択してください</option>
                <option value="print">印刷仕上げ</option>
                <option value="photo">写真キレイ仕上げ</option>
              </select>
            </div>

            <!-- はがき種 -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">はがき種</label>
              <select id="cardType" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">選択してください</option>
                <option>お年玉付き年賀はがき</option>
                <option>通常郵便はがき</option>
                <option>私製はがき(一般)</option>
                <option>私製はがき(喪中用)</option>
                <option>私製はがき(年賀印つき)</option>
              </select>
            </div>
          </div>

          <!-- 2行目 -->
          <div class="mt-4 grid grid-cols-12 gap-4">
            <!-- 注文枚数 -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">注文枚数</label>
              <div class="relative">
                <input id="orderQty" inputmode="numeric" placeholder="例: 30" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">枚</span>
              </div>
            </div>

            <!-- 持込はがき -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">持込はがき</label>
              <div class="relative">
                <input id="bringInQty" inputmode="numeric" placeholder="例: 10" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">枚</span>
              </div>
            </div>

            <!-- クーポン -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">クーポン</label>
              <select id="coupon" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">選択してください</option>
                <option>500</option>
                <option>400</option>
                <option>300</option>
                <option>200</option>
              </select>
            </div>

            <!-- 割引（クーポンの右） -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">割引</label>
              <div class="flex flex-wrap items-center gap-6 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                <label class="inline-flex items-center gap-2 select-none">
                  <input id="superEarly" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                  <span class="text-[15px]">超早割（×0.8）</span>
                </label>
                <label class="inline-flex items-center gap-2 select-none">
                  <input id="early" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                  <span class="text-[15px]">早割（×0.9）</span>
                </label>
              </div>
            </div>
          </div>

          <!-- 宛名行（注文枚数の行の下） -->
          <div class="mt-3 grid grid-cols-12 gap-4">
            <!-- 宛名印刷（データ） -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">宛名印刷（データ）</label>
              <div class="relative">
                <input id="addrDataCount" inputmode="numeric" placeholder="例: 20" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">枚</span>
              </div>
            </div>

            <!-- 宛名印刷（紙媒体） -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">宛名印刷（紙媒体）</label>
              <div class="relative">
                <input id="addrPaperCount" inputmode="numeric" placeholder="例: 15" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">枚</span>
              </div>
            </div>

            <!-- 宛名修正 -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">宛名修正</label>
              <div class="relative">
                <input id="addrFixCount" inputmode="numeric" placeholder="例: 5" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">枚</span>
              </div>
            </div>
          </div>

          <!-- 3行目：オプション枠（横一列 → 折返しグリッド） -->
          <div class="mt-6 rounded-2xl border border-slate-200 bg-white/60 p-4">
            <div class="mb-2 text-[15px] font-semibold tracking-wide text-slate-700">オプション</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optOmakaseOrder" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">おまかせ注文（1,500円）</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optCommentOnly" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">コメントのみおまかせ（1,000円）</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optLogo" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">ロゴ入れ（1,200円）</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optProof" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">校正サービス（1,200円）</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optLogoCut" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">ロゴ切り抜き（1,200円）</span>
              </label>
              <div class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
                <label for="optScanCount" class="text-[15px]">スキャンサービス</label>
                <input id="optScanCount" inputmode="numeric" placeholder="枚数" class="w-24 rounded-lg border border-slate-300 bg-white px-2 py-1 outline-none focus:border-slate-400" />
                <span class="text-sm text-slate-500">（600円/枚）</span>
              </div>
            </div>

            <!-- 計算ボタン -->
            <div class="mt-4 flex justify-end">
              <button id="btnCalc" type="button" class="inline-flex items-center justify-center rounded-xl bg-slate-800 px-4 py-2 text-white shadow-sm transition hover:bg-slate-700">
                計算する
              </button>
            </div>

            <!-- エラー表示 -->
            <div id="error" class="mt-4 hidden rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>
          </div>

          <!-- 合計グリッド（2行6列） -->
          <div id="result" class="mt-6 hidden rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="mb-2 text-[15px] font-semibold tracking-wide text-slate-700">合計</div>
            <div class="overflow-x-auto">
              <table class="min-w-full border-collapse text-[15px]">
                <thead>
                  <tr id="dueHead" class="border-b border-slate-200"></tr>
                </thead>
                <tbody>
                  <tr id="dueAmount" class=""></tr>
                </tbody>
              </table>
            </div>
            <div id="breakdown" class="mt-3 text-xs text-slate-600"></div>

            <!-- 料金明細（クリックで表示） -->
            <div id="invoice" class="mt-6 hidden rounded-xl border border-slate-200 bg-white p-4">
              <div class="mb-3 text-left text-[15px] font-semibold tracking-wide text-slate-700">料金明細表</div>
              <div class="overflow-x-auto">
                <table class="min-w-full border-collapse text-[14px]">
                  <thead>
                    <tr class="border-b border-slate-200 bg-slate-50 text-slate-700">
                      <th class="px-3 py-2 text-left">項目</th>
                      <th class="px-3 py-2 text-left">品名</th>
                      <th class="px-3 py-2 text-left">バーコード</th>
                      <th class="px-3 py-2 text-right">単価</th>
                      <th class="px-3 py-2 text-right">数量</th>
                      <th class="px-3 py-2 text-right">合計</th>
                    </tr>
                  </thead>
                  <tbody id="invBody"></tbody>
                </table>
              </div>
              <!-- サマリー（表の下） -->
              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div></div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <div class="flex items-center justify-between text-[14px]"><span>合計（はがきを除く）</span><span id="sumExclCard" class="font-semibold"></span></div>
                  <div class="mt-2 flex items-center justify-between text-[14px]"><span>はがき代</span><span id="sumCardCost" class="font-semibold"></span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer class="mx-auto mt-6 max-w-[1024px] px-1 text-center text-xs text-slate-500">
        GitHub Pages 用の単一HTMLです。仕様変更はJSのテーブルを書き換えるだけで反映されます。
      </footer>
    </main>

    <script>
      // --- 入力サニタイズ（半角数字のみ） ---
      const numOnly = (el) => el && el.addEventListener('input', () => el.value = (el.value || '').replace(/[^0-9]/g, ''));
      ['orderQty','bringInQty','addrDataCount','addrPaperCount','addrFixCount','optScanCount'].forEach(id => numOnly(document.getElementById(id)));

      // --- はがき単価 ---
      const CARD_UNIT_PRICE = {
        "お年玉付き年賀はがき": 85,
        "通常郵便はがき": 85,
        "私製はがき(一般)": 0,
        "私製はがき(喪中用)": 0,
        "私製はがき(年賀印つき)": 0,
      };

      // --- 絵柄コード→グレード ---
      const CODE_TO_GRADE = (() => {
        const map = {};
        ['PHG','DN','ZN','RN','UN','SN','LN'].forEach(c => map[c] = 'HIGH');     // ハイグレード★★★★
        ['PPR','DO','ZO','UO','BN'].forEach(c => map[c] = 'PREMIUM');            // プレミアム★★★
        ['PSD','BO'].forEach(c => map[c] = 'STANDARD');                           // スタンダード★★
        ['PLT'].forEach(c => map[c] = 'LIGHT');                                   // ライト★
        ['MY'].forEach(c => map[c] = 'MY');                                       // MYデザイン
        return map;
      })();

      // --- 印刷代 基本10枚価格 ---
      const BASE10_PRICE = {
        HIGH:     { print: 5500, photo: 5700 },
        PREMIUM:  { print: 5000, photo: 5200 },
        STANDARD: { print: 4500, photo: 4700 },
        LIGHT:    { print: 3500, photo: 3700 },
        MY:       { print: 2500, photo: 2700 },
      };

      // --- 仕上がり別の加算 ---
      const STEP_PRINT = { first50: 650, next50: 600, over100: 550 }; // 印刷仕上げ
      const STEP_PHOTO = 660; // 写真キレイ仕上げ（10枚ごと一定）

      // --- 納期加算 ---
      const DUE_ADD = [1480, 1180, 880, 580, 300, 0]; // 当日〜5日後
      const DUE_LABELS = [
        { name: "当日仕上げ", offset: 0 },
        { name: "翌日仕上げ", offset: 1 },
        { name: "2日後仕上げ", offset: 2 },
        { name: "3日後仕上げ", offset: 3 },
        { name: "4日後仕上げ", offset: 4 },
        { name: "5日後仕上げ", offset: 5 },
      ];

      // --- 宛名/オプション 単価 ---
      const UNIT = {
        addrData: 80,
        addrPaper: 200,
        addrFix: 50,
        scan: 600,
        omakase: 1500,
        commentOnly: 1000,
        logo: 1200,
        proof: 1200,
        logoCut: 1200,
      };

      // --- util ---
      const yen = (n) => (Math.round(n || 0)).toLocaleString('ja-JP');
      const toInt = (s) => {
        const v = parseInt(String(s || '').replace(/[^0-9]/g, ''), 10);
        return Number.isFinite(v) ? v : 0;
      };
      const ceil10 = (n) => Math.max(10, Math.ceil((n || 0)/10) * 10);
      const addDays = (date, days) => new Date(date.getFullYear(), date.getMonth(), date.getDate() + days);
      const fmtMD = (date) => date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });

      // --- 印刷代の計算 ---
      function calcPrintPrice(code, finish, qtyRaw, isSuperEarly, isEarly) {
        const grade = CODE_TO_GRADE[code];
        if (!grade || !finish) return 0;
        const base = BASE10_PRICE[grade][finish];
        const qty = ceil10(qtyRaw);           // 10枚単位に切り上げ
        const blocks = Math.max(1, qty/10);   // 10枚=1ブロック

        let price = base;
        if (blocks > 1) {
          if (finish === 'photo') {
            price += (blocks - 1) * STEP_PHOTO;
          } else {
            // 印刷仕上げ: 20〜50まで650, 60〜100まで600, 110〜は550
            const b = blocks;
            const c650 = Math.max(0, Math.min(b, 5) - 1);   // blocks 2..5 -> 4段階
            const c600 = Math.max(0, Math.min(b, 10) - 5);  // blocks 6..10
            const c550 = Math.max(0, b - 10);               // blocks 11..
            price += c650 * STEP_PRINT.first50 + c600 * STEP_PRINT.next50 + c550 * STEP_PRINT.over100;
          }
        }

        // 割引（印刷代にのみ適用）。両方チェック時はよりお得な係数(0.8)を優先。
        const factor = isSuperEarly ? 0.8 : (isEarly ? 0.9 : 1.0);
        return Math.round(price * factor);
      }

      // --- はがき代の計算 ---
      function calcCardCost(type, orderQty, bringInQty) {
        const unit = CARD_UNIT_PRICE[type] ?? 0;
        const required = Math.max(0, toInt(orderQty) - toInt(bringInQty));
        return required * unit;
      }

      // --- 宛名/オプションの計算 ---
      function calcOptions(state) {
        const addr =
          state.addrDataCount * UNIT.addrData +
          state.addrPaperCount * UNIT.addrPaper +
          state.addrFixCount * UNIT.addrFix;

        const checks =
          (state.optOmakaseOrder ? UNIT.omakase : 0) +
          (state.optCommentOnly ? UNIT.commentOnly : 0) +
          (state.optLogo ? UNIT.logo : 0) +
          (state.optProof ? UNIT.proof : 0) +
          (state.optLogoCut ? UNIT.logoCut : 0);

        const scans = state.optScanCount * UNIT.scan;

        return { addr, checks, scans, optionsTotal: addr + checks + scans };
      }

      // --- 明細テーブル描画 ---
      function renderInvoice(selectedIdx, state) {
        const printPrice = calcPrintPrice(state.artwork, state.finish, state.orderQty, state.superEarly, state.early);
        const cardCost   = calcCardCost(state.cardType, state.orderQty, state.bringInQty);
        const opt        = calcOptions(state);
        const dueAdd     = (DUE_ADD[selectedIdx] || 0);

        const items = [];
        const finLabel = state.finish === 'photo' ? '写真キレイ仕上げ' : '印刷仕上げ';
        items.push({ cat: '印刷', name: `${finLabel} / ${state.artwork || '-'}`, code: 'BC-PRINT', unit: printPrice, qty: 1, sum: printPrice });
        items.push({ cat: '納期加算', name: DUE_LABELS[selectedIdx]?.name || '-', code: `BC-DUE-${selectedIdx}`, unit: dueAdd, qty: 1, sum: dueAdd });

        if (state.addrDataCount > 0)  items.push({ cat: '宛名', name: '宛名印刷（データ）', code: 'BC-ADDR-D', unit: UNIT.addrData,  qty: state.addrDataCount, sum: UNIT.addrData  * state.addrDataCount });
        if (state.addrPaperCount > 0) items.push({ cat: '宛名', name: '宛名印刷（紙媒体）', code: 'BC-ADDR-P', unit: UNIT.addrPaper, qty: state.addrPaperCount, sum: UNIT.addrPaper * state.addrPaperCount });
        if (state.addrFixCount > 0)   items.push({ cat: '宛名', name: '宛名修正',           code: 'BC-ADDR-F', unit: UNIT.addrFix,   qty: state.addrFixCount,  sum: UNIT.addrFix   * state.addrFixCount  });

        if (state.optOmakaseOrder) items.push({ cat: 'OP', name: 'おまかせ注文',     code: 'BC-OMAKASE', unit: UNIT.omakase,    qty: 1, sum: UNIT.omakase });
        if (state.optCommentOnly)  items.push({ cat: 'OP', name: 'コメントのみおまかせ', code: 'BC-CMT',     unit: UNIT.commentOnly, qty: 1, sum: UNIT.commentOnly });
        if (state.optLogo)         items.push({ cat: 'OP', name: 'ロゴ入れ',         code: 'BC-LOGO',    unit: UNIT.logo,       qty: 1, sum: UNIT.logo });
        if (state.optProof)        items.push({ cat: 'OP', name: '校正サービス',     code: 'BC-PROOF',   unit: UNIT.proof,      qty: 1, sum: UNIT.proof });
        if (state.optLogoCut)      items.push({ cat: 'OP', name: 'ロゴ切り抜き',     code: 'BC-LOGOCUT', unit: UNIT.logoCut,    qty: 1, sum: UNIT.logoCut });
        if (state.optScanCount>0)  items.push({ cat: 'OP', name: 'スキャンサービス', code: 'BC-SCAN',    unit: UNIT.scan,       qty: state.optScanCount, sum: UNIT.scan * state.optScanCount });

        if (state.coupon>0)        items.push({ cat: '値引', name: 'クーポン',      code: 'BC-COUPON',  unit: -state.coupon,   qty: 1, sum: -state.coupon });

        const tbody = document.getElementById('invBody');
        tbody.innerHTML = '';
        items.forEach(it => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-slate-100';
          tr.innerHTML = `
            <td class="px-3 py-2">${it.cat}</td>
            <td class="px-3 py-2">${it.name}</td>
            <td class="px-3 py-2">${it.code}</td>
            <td class="px-3 py-2 text-right">¥${yen(it.unit)}</td>
            <td class="px-3 py-2 text-right">${it.qty}</td>
            <td class="px-3 py-2 text-right">¥${yen(it.sum)}</td>
          `;
          tbody.appendChild(tr);
        });

        const sumExcl = printPrice + opt.optionsTotal - state.coupon + dueAdd; // はがき代を除く
        document.getElementById('sumExclCard').textContent = `¥${yen(sumExcl)}`;
        document.getElementById('sumCardCost').textContent = `¥${yen(cardCost)}`;

        const invoice = document.getElementById('invoice');
        invoice.classList.remove('hidden');
        // スクロールして見せる
        invoice.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // --- 計算ボタン ---
      document.getElementById('btnCalc').addEventListener('click', () => {
        const err = document.getElementById('error');
        err.classList.add('hidden');
        err.textContent = '';

        const state = {
          artwork: document.getElementById('artwork').value,
          finish: document.getElementById('finish').value,
          cardType: document.getElementById('cardType').value,
          orderQty: toInt(document.getElementById('orderQty').value),
          bringInQty: toInt(document.getElementById('bringInQty').value),
          coupon: toInt(document.getElementById('coupon').value),
          superEarly: document.getElementById('superEarly').checked,
          early: document.getElementById('early').checked,
          addrDataCount: toInt(document.getElementById('addrDataCount').value),
          addrPaperCount: toInt(document.getElementById('addrPaperCount').value),
          addrFixCount: toInt(document.getElementById('addrFixCount').value),
          optOmakaseOrder: document.getElementById('optOmakaseOrder').checked,
          optCommentOnly: document.getElementById('optCommentOnly').checked,
          optLogo: document.getElementById('optLogo').checked,
          optProof: document.getElementById('optProof').checked,
          optLogoCut: document.getElementById('optLogoCut').checked,
          optScanCount: toInt(document.getElementById('optScanCount').value),
        };

        if (state.orderQty <= 0) {
          err.textContent = "注文枚数を入力してください。";
          err.classList.remove('hidden');
          document.getElementById('result').classList.add('hidden');
          return;
        }
        if (state.bringInQty > state.orderQty) {
          err.textContent = "持込はがきは、注文枚数以下にしてください。";
          err.classList.remove('hidden');
          document.getElementById('result').classList.add('hidden');
          return;
        }

        // 計算
        const printPrice = calcPrintPrice(state.artwork, state.finish, state.orderQty, state.superEarly, state.early);
        const cardCost = calcCardCost(state.cardType, state.orderQty, state.bringInQty);
        const opt = calcOptions(state);
        const coupon = state.coupon;

        // 合計（納期加算を除く）
        const baseTotal = Math.max(0, printPrice + cardCost + opt.optionsTotal - coupon);

        // テーブル構築
        const head = document.getElementById('dueHead');
        const amt = document.getElementById('dueAmount');
        head.innerHTML = "";
        amt.innerHTML = "";

        const today = new Date();
        DUE_LABELS.forEach((l, idx) => {
          const d = addDays(today, l.offset);
          const th = document.createElement('th');
          th.className = "px-3 py-2 text-center align-bottom";
          th.innerHTML = `<div class="text-[14px] font-medium text-slate-700">${l.name}</div>
                          <div class="mt-0.5 text-xs text-slate-500">${fmtMD(d)}</div>`;
          head.appendChild(th);

          const td = document.createElement('td');
          td.className = "px-3 py-3 text-center text-[16px] font-semibold cursor-pointer hover:bg-slate-50 rounded";
          const totalWithDue = baseTotal + DUE_ADD[idx];
          td.textContent = `${yen(totalWithDue)} 円`;
          td.dataset.dueIdx = idx;
          td.title = "クリックで料金明細を表示";
          td.addEventListener('click', () => {
            const st = {
              artwork: document.getElementById('artwork').value,
              finish: document.getElementById('finish').value,
              cardType: document.getElementById('cardType').value,
              orderQty: toInt(document.getElementById('orderQty').value),
              bringInQty: toInt(document.getElementById('bringInQty').value),
              coupon: toInt(document.getElementById('coupon').value),
              superEarly: document.getElementById('superEarly').checked,
              early: document.getElementById('early').checked,
              addrDataCount: toInt(document.getElementById('addrDataCount').value),
              addrPaperCount: toInt(document.getElementById('addrPaperCount').value),
              addrFixCount: toInt(document.getElementById('addrFixCount').value),
              optOmakaseOrder: document.getElementById('optOmakaseOrder').checked,
              optCommentOnly: document.getElementById('optCommentOnly').checked,
              optLogo: document.getElementById('optLogo').checked,
              optProof: document.getElementById('optProof').checked,
              optLogoCut: document.getElementById('optLogoCut').checked,
              optScanCount: toInt(document.getElementById('optScanCount').value),
            };
            renderInvoice(idx, st);
          });
          amt.appendChild(td);
        });

        // 内訳（軽く表示）
        const breakdown = document.getElementById('breakdown');
        breakdown.innerHTML = `
          <div class="flex flex-wrap items-center gap-3">
            <span class="pill">印刷代: <b>¥${yen(printPrice)}</b></span>
            <span class="pill">はがき代: <b>¥${yen(cardCost)}</b></span>
            <span class="pill">宛名: <b>¥${yen(opt.addr)}</b></span>
            <span class="pill">その他オプション: <b>¥${yen(opt.checks + opt.scans)}</b></span>
            <span class="pill">クーポン: <b>−¥${yen(coupon)}</b></span>
            <span class="pill">小計(納期加算前): <b>¥${yen(baseTotal)}</b></span>
          </div>
        `;

        const invoiceEl = document.getElementById('invoice'); if (invoiceEl) invoiceEl.classList.add('hidden');
        document.getElementById('result').classList.remove('hidden');
      });

      // --- 開発用ミニ自己テスト（コンソール出力）---
      (function runSelfTests(){
        try {
          console.group("SelfTests");
          console.assert(ceil10(12) === 20, 'ceil10(12) should be 20');
          console.assert(ceil10(39) === 40, 'ceil10(39) should be 40');

          // HIGH / print / 10枚 -> 5500
          console.assert(calcPrintPrice('PHG','print',10,false,false) === 5500, 'HIGH/print/10 should be 5500');
          // HIGH / print / 60枚 -> 5500 + 650*4 + 600*1 = 8700
          console.assert(calcPrintPrice('PHG','print',60,false,false) === 8700, 'HIGH/print/60 should be 8700');
          // HIGH / photo / 30枚 -> 5700 + 660*(3-1) = 7020
          console.assert(calcPrintPrice('PHG','photo',30,false,false) === 7020, 'HIGH/photo/30 should be 7020');
          console.log('All tests passed.');
          console.groupEnd();
        } catch(e){
          console.error('SelfTests failed:', e);
        }
      })();

      // 外部から状態を取得（デバッグ用途）
      window.getFormState = () => ({
        artwork: document.getElementById('artwork').value,
        finish: document.getElementById('finish').value,
        cardType: document.getElementById('cardType').value,
        orderQty: document.getElementById('orderQty').value,
        bringInQty: document.getElementById('bringInQty').value,
        coupon: document.getElementById('coupon').value,
        superEarly: document.getElementById('superEarly').checked,
        early: document.getElementById('early').checked,
        addrDataCount: document.getElementById('addrDataCount').value,
        addrPaperCount: document.getElementById('addrPaperCount').value,
        addrFixCount: document.getElementById('addrFixCount').value,
        optOmakaseOrder: document.getElementById('optOmakaseOrder').checked,
        optCommentOnly: document.getElementById('optCommentOnly').checked,
        optLogo: document.getElementById('optLogo').checked,
        optProof: document.getElementById('optProof').checked,
        optLogoCut: document.getElementById('optLogoCut').checked,
        optScanCount: document.getElementById('optScanCount').value,
      });
    </script>
  </body>
</html>
