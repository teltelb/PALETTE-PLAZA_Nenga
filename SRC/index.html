<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ãƒ‘ãƒ¬ãƒƒãƒˆãƒ—ãƒ©ã‚¶ å¹´è³€çŠ¶ è¦‹ç©ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰å¯¾å¿œï¼‰</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JsBarcode for EAN-8 / CODE128 -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            boxShadow: { soft: "0 1px 2px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.06)" },
            borderRadius: { '2xl': '1rem' }
          },
        },
      };
    </script>
    <style>
      .pill { display:inline-flex; align-items:center; gap:.5rem; border-radius:9999px; background:#f1f5f9; padding:.25rem .75rem; font-size:12px; color:#475569; }
      .bc-box { display:inline-flex; align-items:center; justify-content:center; padding:.25rem .5rem; border-radius:.5rem; background:#fff; border:1px solid #e2e8f0; }
      dialog { border:none; }
    </style>
  </head>
  <body class="min-h-screen w-full bg-gradient-to-br from-slate-50 to-slate-100 text-slate-800">
    <main class="mx-auto max-w-[1024px] px-5 py-8">
      <section class="rounded-2xl border border-slate-200 bg-white/70 shadow-soft backdrop-blur">
        <header class="flex items-center justify-between gap-3 border-b border-slate-100 p-5">
          <h1 class="text-xl font-semibold tracking-tight">å¹´è³€çŠ¶ è¦‹ç©ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰å¯¾å¿œï¼‰</h1>
          <div class="flex items-center gap-2">
            <button id="btnBarcodeCfg" type="button" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-[13px] text-slate-700 hover:bg-slate-50">âš™ï¸ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è¨­å®š</button>
            <button id="btnBarcodeBulk" type="button" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-[13px] text-slate-700 hover:bg-slate-50">ğŸ“„ ãƒšãƒ¼ã‚¸è²¼ä»˜ã§ç™»éŒ²</button>
          </div>
        </header>

        <div class="p-5">
          <!-- 1è¡Œç›® -->
          <div class="grid grid-cols-12 gap-4">
            <!-- çµµæŸ„ï¼ˆã‚³ãƒ¼ãƒ‰ï¼‰ -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">çµµæŸ„</label>
              <select id="artwork" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <!-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ãƒ‰â˜…â˜…â˜…â˜… -->
                <option>PHG</option><option>DN</option><option>ZN</option><option>RN</option><option>UN</option><option>SN</option><option>LN</option>
                <!-- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ â˜…â˜…â˜… -->
                <option>PPR</option><option>DO</option><option>ZO</option><option>UO</option><option>BN</option>
                <!-- ã‚¹ã‚¿ãƒ³ãƒ€ãƒ¼ãƒ‰â˜…â˜… -->
                <option>PSD</option><option>BO</option>
                <!-- ãƒ©ã‚¤ãƒˆâ˜… -->
                <option>PLT</option>
                <!-- MYãƒ‡ã‚¶ã‚¤ãƒ³ï¼ˆå€¤ã¯MYï¼‰ -->
                <option value="MY">MYãƒ‡ã‚¶ã‚¤ãƒ³</option>
              </select>
            </div>

            <!-- ä»•ä¸ŠãŒã‚Š -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">ä»•ä¸ŠãŒã‚Š</label>
              <select id="finish" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option value="print">å°åˆ·ä»•ä¸Šã’</option>
                <option value="photo">å†™çœŸã‚­ãƒ¬ã‚¤ä»•ä¸Šã’</option>
              </select>
            </div>

            <!-- ã¯ãŒãç¨® -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">ã¯ãŒãç¨®</label>
              <select id="cardType" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option>ãŠå¹´ç‰ä»˜ãå¹´è³€ã¯ãŒã</option>
                <option>é€šå¸¸éƒµä¾¿ã¯ãŒã</option>
                <option>ç§è£½ã¯ãŒã(ä¸€èˆ¬)</option>
                <option>ç§è£½ã¯ãŒã(å–ªä¸­ç”¨)</option>
                <option>ç§è£½ã¯ãŒã(å¹´è³€å°ã¤ã)</option>
              </select>
            </div>
          </div>

          <!-- 2è¡Œç›® -->
          <div class="mt-4 grid grid-cols-12 gap-4">
            <!-- æ³¨æ–‡æšæ•° -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">æ³¨æ–‡æšæ•°</label>
              <div class="relative">
                <input id="orderQty" inputmode="numeric" placeholder="ä¾‹: 30" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">æš</span>
              </div>
            </div>

            <!-- æŒè¾¼ã¯ãŒã -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">æŒè¾¼ã¯ãŒã</label>
              <div class="relative">
                <input id="bringInQty" inputmode="numeric" placeholder="ä¾‹: 10" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">æš</span>
              </div>
            </div>

            <!-- ã‚¯ãƒ¼ãƒãƒ³ -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">ã‚¯ãƒ¼ãƒãƒ³</label>
              <select id="coupon" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 outline-none focus:border-slate-400 focus:shadow-sm">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                <option>500</option>
                <option>400</option>
                <option>300</option>
                <option>200</option>
              </select>
            </div>

            <!-- å‰²å¼•ï¼ˆã‚¯ãƒ¼ãƒãƒ³ã®å³ï¼‰ -->
            <div class="col-span-12 sm:col-span-6 md:col-span-3">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">å‰²å¼•</label>
              <div class="flex flex-wrap items-center gap-6 rounded-xl border border-slate-200 bg-slate-50 px-4 py-3">
                <label class="inline-flex items-center gap-2 select-none">
                  <input id="superEarly" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                  <span class="text-[15px]">è¶…æ—©å‰²ï¼ˆÃ—0.8ï¼‰</span>
                </label>
                <label class="inline-flex items-center gap-2 select-none">
                  <input id="early" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                  <span class="text-[15px]">æ—©å‰²ï¼ˆÃ—0.9ï¼‰</span>
                </label>
              </div>
            </div>
          </div>

          <!-- å®›åè¡Œï¼ˆæ³¨æ–‡æšæ•°ã®è¡Œã®ä¸‹ï¼‰ -->
          <div class="mt-3 grid grid-cols-12 gap-4">
            <!-- å®›åå°åˆ·ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰ -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">å®›åå°åˆ·ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰</label>
              <div class="relative">
                <input id="addrDataCount" inputmode="numeric" placeholder="ä¾‹: 20" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">æš</span>
              </div>
            </div>

            <!-- å®›åå°åˆ·ï¼ˆç´™åª’ä½“ï¼‰ -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">å®›åå°åˆ·ï¼ˆç´™åª’ä½“ï¼‰</label>
              <div class="relative">
                <input id="addrPaperCount" inputmode="numeric" placeholder="ä¾‹: 15" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">æš</span>
              </div>
            </div>

            <!-- å®›åä¿®æ­£ -->
            <div class="col-span-12 sm:col-span-6 md:col-span-4">
              <label class="mb-1 block text-[13px] font-medium text-slate-600">å®›åä¿®æ­£</label>
              <div class="relative">
                <input id="addrFixCount" inputmode="numeric" placeholder="ä¾‹: 5" class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 pr-10 outline-none focus:border-slate-400 focus:shadow-sm" />
                <span class="pointer-events-none absolute inset-y-0 right-3 my-auto inline-flex h-[22px] items-center text-sm text-slate-500">æš</span>
              </div>
            </div>
          </div>

          <!-- 3è¡Œç›®ï¼šã‚ªãƒ—ã‚·ãƒ§ãƒ³æ  -->
          <div class="mt-6 rounded-2xl border border-slate-200 bg-white/60 p-4">
            <div class="mb-2 text-[15px] font-semibold tracking-wide text-slate-700">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optOmakaseOrder" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">ãŠã¾ã‹ã›æ³¨æ–‡</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optCommentOnly" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ãŠã¾ã‹ã›</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optLogo" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">ãƒ­ã‚´å…¥ã‚Œ</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optProof" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">æ ¡æ­£ã‚µãƒ¼ãƒ“ã‚¹</span>
              </label>
              <label class="group inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 transition hover:bg-slate-100">
                <input id="optLogoCut" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-slate-700 focus:ring-0" />
                <span class="text-[15px]">ãƒ­ã‚´åˆ‡ã‚ŠæŠœã</span>
              </label>
              <div class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2">
                <label for="optScanCount" class="text-[15px]">ã‚¹ã‚­ãƒ£ãƒ³ã‚µãƒ¼ãƒ“ã‚¹</label>
                <input id="optScanCount" inputmode="numeric" placeholder="æšæ•°" class="w-24 rounded-lg border border-slate-300 bg-white px-2 py-1 outline-none focus:border-slate-400" />
              </div>
            </div>

            <!-- è¨ˆç®—ãƒœã‚¿ãƒ³ -->
            <div class="mt-4 flex items-center justify-between">
              <div class="text-xs text-slate-500">â€»è¨ˆç®—å¾Œã€ä¸Šæ®µã®ã€Œå½“æ—¥ã€œ5æ—¥å¾Œã€ã®ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ä¸‹éƒ¨ã«ã€Œæ–™é‡‘æ˜ç´°è¡¨ã€ã¨ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
              <button id="btnCalc" type="button" class="inline-flex items-center justify-center rounded-xl bg-slate-800 px-4 py-2 text-white shadow-sm transition hover:bg-slate-700">
                è¨ˆç®—ã™ã‚‹
              </button>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
            <div id="error" class="mt-4 hidden rounded-xl border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>
          </div>

          <!-- åˆè¨ˆã‚°ãƒªãƒƒãƒ‰ï¼ˆ2è¡Œ6åˆ—ï¼‰ -->
          <div id="result" class="mt-6 hidden rounded-2xl border border-slate-200 bg-white/70 p-4">
            <div class="mb-2 text-[15px] font-semibold tracking-wide text-slate-700">åˆè¨ˆ</div>
            <div class="overflow-x-auto">
              <table class="min-w-full border-collapse text-[15px]">
                <thead>
                  <tr id="dueHead" class="border-b border-slate-200"></tr>
                </thead>
                <tbody>
                  <tr id="dueAmount" class=""></tr>
                </tbody>
              </table>
            </div>
            <div id="breakdown" class="mt-3 text-xs text-slate-600"></div>

            <!-- æ–™é‡‘æ˜ç´°ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§è¡¨ç¤ºï¼‰ -->
            <div id="invoice" class="mt-6 hidden rounded-xl border border-slate-200 bg-white p-4">
              <div class="mb-3 text-left text-[15px] font-semibold tracking-wide text-slate-700">æ–™é‡‘æ˜ç´°è¡¨</div>
              <div class="overflow-x-auto">
                <table class="min-w-full border-collapse text-[14px]">
                  <thead>
                    <tr class="border-b border-slate-200 bg-slate-50 text-slate-700">
                      <th class="px-3 py-2 text-left">é …ç›®</th>
                      <th class="px-3 py-2 text-left">å“å</th>
                      <th class="px-3 py-2 text-left">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th>
                      <th class="px-3 py-2 text-right">å˜ä¾¡</th>
                      <th class="px-3 py-2 text-right">æ•°é‡</th>
                      <th class="px-3 py-2 text-right">åˆè¨ˆ</th>
                    </tr>
                  </thead>
                  <tbody id="invBody"></tbody>
                </table>
              </div>
              <!-- ã‚µãƒãƒªãƒ¼ï¼ˆè¡¨ã®ä¸‹ï¼‰ -->
              <div class="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div></div>
                <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
                  <div class="flex items-center justify-between text-[14px]"><span>åˆè¨ˆï¼ˆã¯ãŒãã‚’é™¤ãï¼‰</span><span id="sumExclCard" class="font-semibold"></span></div>
                  <div class="mt-2 flex items-center justify-between text-[14px]"><span>ã¯ãŒãä»£</span><span id="sumCardCost" class="font-semibold"></span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <footer class="mx-auto mt-6 max-w-[1024px] px-1 text-center text-xs text-slate-500">
        å˜ä¸€HTMLã€‚ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã¯ã“ã®ãƒšãƒ¼ã‚¸å†…ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆlocalStorageï¼‰ã§ç®¡ç†ã—ã¾ã™ã€‚
      </footer>
    </main>

    <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è¨­å®šï¼ˆå€‹åˆ¥ï¼šç´æœŸ/å®›å/OP/ã‚¯ãƒ¼ãƒãƒ³ï¼‰ -->
    <dialog id="dlgBarcode">
      <form method="dialog" class="w-[min(92vw,760px)] rounded-2xl border border-slate-200 bg-white">
        <div class="flex items-center justify-between border-b border-slate-100 p-4">
          <h2 class="text-base font-semibold">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è¨­å®šï¼ˆå€‹åˆ¥ï¼‰</h2>
          <button class="rounded-md px-2 py-1 text-sm text-slate-600 hover:bg-slate-100">âœ•</button>
        </div>
        <div class="p-4 space-y-3">
          <p class="text-sm text-slate-600">ã‚­ãƒ¼ â†’ 8æ¡ EAN-8 ã‚’JSONã§ä¿å­˜ã—ã¾ã™ã€‚å°åˆ·ï¼ˆæ•°é‡å¸¯ï¼‰ã¯ä¸‹ã®ã€Œãƒšãƒ¼ã‚¸è²¼ä»˜ã§ç™»éŒ²ã€ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚</p>
          <div class="rounded-lg border border-slate-200 bg-slate-50 p-2 text-xs">
            <p class="mb-1 font-semibold">ã‚­ãƒ¼ä¾‹</p>
            <ul class="list-disc pl-5 space-y-1">
              <li><code>DUE|å½“æ—¥ä»•ä¸Šã’</code>, <code>DUE|ç¿Œæ—¥ä»•ä¸Šã’</code> â€¦ ç´æœŸåŠ ç®—</li>
              <li><code>ADDR|DATA</code>, <code>ADDR|PAPER</code>, <code>ADDR|FIX</code> â€¦ å®›å</li>
              <li><code>OP|OMAKASE</code>, <code>OP|COMMENT</code>, <code>OP|LOGO</code>, <code>OP|PROOF</code>, <code>OP|LOGOCUT</code>, <code>OP|SCAN</code></li>
              <li><code>COUPON|500</code>, <code>COUPON|400</code>, <code>COUPON|300</code>, <code>COUPON|200</code></li>
            </ul>
          </div>
          <textarea id="barcodeJson" rows="12" class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs" spellcheck="false"></textarea>
          <div class="flex items-center justify-between">
            <div class="text-xs text-slate-500">â€»8æ¡ã¯EAN-8ãƒã‚§ãƒƒã‚¯ã‚’æ¤œè¨¼ã—ã¾ã™ï¼ˆä¸ä¸€è‡´ã¯ä¿å­˜ä¸å¯ï¼‰ã€‚</div>
            <div class="flex items-center gap-2">
              <button id="btnBarcodeReset" type="button" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm hover:bg-slate-50">åˆæœŸåŒ–</button>
              <button id="btnBarcodeSave" type="button" class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-white hover:bg-slate-700">ä¿å­˜</button>
            </div>
          </div>
        </div>
      </form>
    </dialog>

    <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼šãƒšãƒ¼ã‚¸è²¼ä»˜ã§ç™»éŒ²ï¼ˆå°åˆ·ï¼šæ•°é‡å¸¯é…åˆ— 10..200,201+ï¼‰ -->
    <dialog id="dlgBulk">
      <form method="dialog" class="w-[min(96vw,880px)] rounded-2xl border border-slate-200 bg-white">
        <div class="flex items-center justify-between border-b border-slate-100 p-4">
          <h2 class="text-base font-semibold">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç™»éŒ²ï¼ˆPDFãƒšãƒ¼ã‚¸ã®8æ¡ã‚’è²¼ä»˜ï¼‰</h2>
          <button class="rounded-md px-2 py-1 text-sm text-slate-600 hover:bg-slate-100">âœ•</button>
        </div>
        <div class="p-4 space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
            <div>
              <label class="block text-xs text-slate-600 mb-1">ä»•ä¸ŠãŒã‚Š</label>
              <select id="bulkFinish" class="w-full rounded-lg border border-slate-300 px-2 py-1.5">
                <option value="print">å°åˆ·ä»•ä¸Šã’</option>
                <option value="photo">å†™çœŸã‚­ãƒ¬ã‚¤ä»•ä¸Šã’</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">ã‚°ãƒ¬ãƒ¼ãƒ‰</label>
              <select id="bulkGrade" class="w-full rounded-lg border border-slate-300 px-2 py-1.5">
                <option value="MY">MY</option>
                <option value="LIGHT">LIGHT</option>
                <option value="STANDARD">STANDARD</option>
                <option value="PREMIUM">PREMIUM</option>
                <option value="HIGH">HIGH</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-600 mb-1">å‰²å¼•</label>
              <select id="bulkDisc" class="w-full rounded-lg border border-slate-300 px-2 py-1.5">
                <option value="NONE">ãªã—ï¼ˆå®šä¾¡ï¼‰</option>
                <option value="EARLY">æ—©å‰²ï¼ˆÃ—0.9åæ˜ ï¼‰</option>
                <option value="SUPER">è¶…æ—©å‰²ï¼ˆÃ—0.8åæ˜ ï¼‰</option>
              </select>
            </div>
            <div class="flex items-end">
              <button id="btnBulkSample" type="button" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm hover:bg-slate-50 w-full">è²¼ä»˜ã‘ä¾‹ã‚’å…¥ã‚Œã‚‹</button>
            </div>
          </div>
          <p class="text-xs text-slate-500">PDFã«ä¸¦ã¶ã€Œ8æ¡ã€ã ã‘ã‚’ã‚³ãƒ”ãƒšã€‚22å€‹ãªã‚‰å…ˆé ­ã®ã€Œ1æšã€ã‚’è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ 10ã€œ200, 201+ ã® 21å¸¯ã«å‰²å½“ã¦ã¾ã™ã€‚</p>
          <textarea id="bulkText" rows="10" class="w-full rounded-xl border border-slate-300 p-3 font-mono text-xs" placeholder="ä¾‹ï¼‰
68208202 68208301 68208400 68208509 â€¦"></textarea>
          <div class="flex items-center justify-between">
            <div class="text-xs text-slate-500">ä¿å­˜å…ˆã‚­ãƒ¼ï¼š<code id="bulkKeyPreview" class="text-amber-700"></code></div>
            <div class="flex items-center gap-2">
              <button id="btnBulkParse" type="button" class="rounded-lg border border-slate-300 bg-white px-3 py-1.5 text-sm hover:bg-slate-50">æ¤œè¨¼</button>
              <button id="btnBulkSave" type="button" class="rounded-lg bg-slate-800 px-3 py-1.5 text-sm text-white hover:bg-slate-700">ä¿å­˜</button>
            </div>
          </div>
          <div id="bulkPreview" class="hidden mt-2 rounded-lg border border-slate-200 bg-slate-50 p-2 text-xs"></div>
        </div>
      </form>
    </dialog>

    <script>
      // ====== å…¥åŠ›ã‚µãƒ‹ã‚¿ã‚¤ã‚º ======
      const numOnly = (el) => el && el.addEventListener('input', () => el.value = (el.value || '').replace(/[^0-9]/g, ''));
      ['orderQty','bringInQty','addrDataCount','addrPaperCount','addrFixCount','optScanCount'].forEach(id => numOnly(document.getElementById(id)));

      // ====== å˜ä¾¡å®šç¾© ======
      const CARD_UNIT_PRICE = {
        "ãŠå¹´ç‰ä»˜ãå¹´è³€ã¯ãŒã": 85,
        "é€šå¸¸éƒµä¾¿ã¯ãŒã": 85,
        "ç§è£½ã¯ãŒã(ä¸€èˆ¬)": 0,
        "ç§è£½ã¯ãŒã(å–ªä¸­ç”¨)": 0,
        "ç§è£½ã¯ãŒã(å¹´è³€å°ã¤ã)": 0,
      };

      // çµµæŸ„ â†’ ã‚°ãƒ¬ãƒ¼ãƒ‰
      const CODE_TO_GRADE = (() => {
        const map = {};
        ['PHG','DN','ZN','RN','UN','SN','LN'].forEach(c => map[c] = 'HIGH');
        ['PPR','DO','ZO','UO','BN'].forEach(c => map[c] = 'PREMIUM');
        ['PSD','BO'].forEach(c => map[c] = 'STANDARD');
        ['PLT'].forEach(c => map[c] = 'LIGHT');
        ['MY'].forEach(c => map[c] = 'MY');
        return map;
      })();

      const BASE10_PRICE = {
        HIGH:     { print: 5500, photo: 5700 },
        PREMIUM:  { print: 5000, photo: 5200 },
        STANDARD: { print: 4500, photo: 4700 },
        LIGHT:    { print: 3500, photo: 3700 },
        MY:       { print: 2500, photo: 2700 },
      };
      const STEP_PRINT = { first50: 650, next50: 600, over100: 550 };
      const STEP_PHOTO = 660;
      const DUE_ADD = [1480, 1180, 880, 580, 300, 0];
      const DUE_LABELS = [
        { name: "å½“æ—¥ä»•ä¸Šã’", offset: 0 },
        { name: "ç¿Œæ—¥ä»•ä¸Šã’", offset: 1 },
        { name: "2æ—¥å¾Œä»•ä¸Šã’", offset: 2 },
        { name: "3æ—¥å¾Œä»•ä¸Šã’", offset: 3 },
        { name: "4æ—¥å¾Œä»•ä¸Šã’", offset: 4 },
        { name: "5æ—¥å¾Œä»•ä¸Šã’", offset: 5 },
      ];
      const UNIT = {
        addrData: 80, addrPaper: 200, addrFix: 50, scan: 600,
        omakase: 1500, commentOnly: 1000, logo: 1200, proof: 1200, logoCut: 1200,
      };

      const BANDS = ["10","20","30","40","50","60","70","80","90","100","110","120","130","140","150","160","170","180","190","200","201+"];
      const LS_KEY_SINGLE = 'barcode.single.v1'; // å€‹åˆ¥é …ç›®ï¼ˆç´æœŸ/å®›å/OP/ã‚¯ãƒ¼ãƒãƒ³ï¼‰
      const LS_KEY_BULK   = 'barcode.bulk.v1';   // å°åˆ·ï¼ˆæ•°é‡å¸¯é…åˆ—ï¼‰

      // ====== Utils ======
      const yen = (n) => (Math.round(n||0)).toLocaleString('ja-JP');
      const toInt = (s) => { const v = parseInt(String(s || '').replace(/[^0-9]/g, ''), 10); return Number.isFinite(v) ? v : 0; };
      const ceil10 = (n) => Math.max(10, Math.ceil((n || 0)/10) * 10);
      const addDays = (date, days) => new Date(date.getFullYear(), date.getMonth(), date.getDate() + days);
      const fmtMD = (date) => date.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric' });

      // ====== EAN-8 åˆ¤å®šï¼æç”» ======
      function isValidEAN8(code){
        if(!/^\d{8}$/.test(code)) return false;
        const d = code.split('').map(Number);
        const sum = 3*(d[0]+d[2]+d[4]+d[6]) + (d[1]+d[3]+d[5]);
        const chk = (10 - (sum % 10)) % 10;
        return chk === d[7];
      }
      function renderBarcodeTo(el, value){
        if(!el) return;
        const text = String(value||'');
        try{
          if (/^\d{8}$/.test(text) && isValidEAN8(text)) {
            JsBarcode(el, text, { format: 'EAN8', displayValue: true, font: 'monospace', fontSize: 12, width: 2, height: 40, margin: 0 });
          } else {
            JsBarcode(el, text, { format: 'CODE128', displayValue: true, font: 'monospace', fontSize: 12, width: 1.8, height: 40, margin: 0 });
          }
        } catch(e){
          el.replaceWith(Object.assign(document.createElement('div'), { className: 'text-xs text-red-600', textContent: `ç”Ÿæˆå¤±æ•—: ${text}` }));
        }
      }

      // ====== è¨ˆç®— ======
      function calcPrintPrice(code, finish, qtyRaw, isSuperEarly, isEarly) {
        const grade = CODE_TO_GRADE[code];
        if (!grade || !finish) return 0;
        const base = BASE10_PRICE[grade][finish];
        const qty = ceil10(qtyRaw);
        const blocks = Math.max(1, qty/10);
        let price = base;
        if (blocks > 1) {
          if (finish === 'photo') {
            price += (blocks - 1) * STEP_PHOTO;
          } else {
            const b = blocks;
            const c650 = Math.max(0, Math.min(b, 5) - 1);
            const c600 = Math.max(0, Math.min(b, 10) - 5);
            const c550 = Math.max(0, b - 10);
            price += c650 * STEP_PRINT.first50 + c600 * STEP_PRINT.next50 + c550 * STEP_PRINT.over100;
          }
        }
        const factor = isSuperEarly ? 0.8 : (isEarly ? 0.9 : 1.0);
        return Math.round(price * factor);
      }
      function calcCardCost(type, orderQty, bringInQty) {
        const unit = CARD_UNIT_PRICE[type] ?? 0;
        const required = Math.max(0, toInt(orderQty) - toInt(bringInQty));
        return required * unit;
      }
      function calcOptions(state) {
        const addr =
          state.addrDataCount * UNIT.addrData +
          state.addrPaperCount * UNIT.addrPaper +
          state.addrFixCount * UNIT.addrFix;
        const checks =
          (state.optOmakaseOrder ? UNIT.omakase : 0) +
          (state.optCommentOnly ? UNIT.commentOnly : 0) +
          (state.optLogo ? UNIT.logo : 0) +
          (state.optProof ? UNIT.proof : 0) +
          (state.optLogoCut ? UNIT.logoCut : 0);
        const scans = state.optScanCount * UNIT.scan;
        return { addr, checks, scans, optionsTotal: addr + checks + scans };
      }

      // ====== ãƒãƒ¼ã‚³ãƒ¼ãƒ‰DB ======
      function loadSingleMap(){ try { return JSON.parse(localStorage.getItem(LS_KEY_SINGLE) || '{}'); } catch { return {}; } }
      function saveSingleMap(obj){ localStorage.setItem(LS_KEY_SINGLE, JSON.stringify(obj || {})); }
      function loadBulkMap(){ try { return JSON.parse(localStorage.getItem(LS_KEY_BULK) || '{}'); } catch { return {}; } }
      function saveBulkMap(obj){ localStorage.setItem(LS_KEY_BULK, JSON.stringify(obj || {})); }

      function discountKey(st){ return st.superEarly? 'SUPER' : (st.early? 'EARLY' : 'NONE'); }
      function qtyToBand(qtyRaw){ const q = ceil10(qtyRaw); return q > 200 ? '201+' : String(q); }
      function buildBulkKey(grade, finish, disc){ return `PRINT|${grade}|${finish}|${disc}`; }

      // ====== æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰æç”»ä»˜ãï¼‰ ======
      function renderInvoice(selectedIdx, state) {
        const grade = CODE_TO_GRADE[state.artwork] || 'MY';
        const disc = discountKey(state);
        const bulkKey = buildBulkKey(grade, state.finish, disc);
        const bulkMap = loadBulkMap();
        const singleMap = loadSingleMap();

        const printPrice = calcPrintPrice(state.artwork, state.finish, state.orderQty, state.superEarly, state.early);
        const cardCost   = calcCardCost(state.cardType, state.orderQty, state.bringInQty);
        const opt        = calcOptions(state);
        const dueAdd     = (DUE_ADD[selectedIdx] || 0);

        const items = [];
        const finLabel = state.finish === 'photo' ? 'å†™çœŸã‚­ãƒ¬ã‚¤ä»•ä¸Šã’' : 'å°åˆ·ä»•ä¸Šã’';

        // å°åˆ·ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ï¼ˆæ•°é‡å¸¯ï¼‰
        const band = qtyToBand(state.orderQty);
        const bulkEntry = bulkMap[bulkKey] || {};
        const bulkCode = bulkEntry[band] || '';
        const printBarcode = bulkCode ? bulkCode : `${bulkKey}|${band}`; // æœªè¨­å®šã¯ã‚­ãƒ¼ã‚’CODE128ã§

        items.push({ cat: 'å°åˆ·', name: `${finLabel} / ${state.artwork || '-'}`, code: printBarcode, unit: printPrice, qty: 1, sum: printPrice });

        // ç´æœŸåŠ ç®—
        const dueName = DUE_LABELS[selectedIdx]?.name || '-';
        const dueKey = `DUE|${dueName}`;
        const dueCode = singleMap[dueKey] || dueKey;
        items.push({ cat: 'ç´æœŸåŠ ç®—', name: dueName, code: dueCode, unit: dueAdd, qty: 1, sum: dueAdd });

        // å®›å
        if (state.addrDataCount > 0)  items.push({ cat: 'å®›å', name: 'å®›åå°åˆ·ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‰', code: (singleMap['ADDR|DATA']||'ADDR|DATA'), unit: UNIT.addrData,  qty: state.addrDataCount, sum: UNIT.addrData  * state.addrDataCount });
        if (state.addrPaperCount > 0) items.push({ cat: 'å®›å', name: 'å®›åå°åˆ·ï¼ˆç´™åª’ä½“ï¼‰', code: (singleMap['ADDR|PAPER']||'ADDR|PAPER'), unit: UNIT.addrPaper, qty: state.addrPaperCount, sum: UNIT.addrPaper * state.addrPaperCount });
        if (state.addrFixCount > 0)   items.push({ cat: 'å®›å', name: 'å®›åä¿®æ­£',           code: (singleMap['ADDR|FIX']||'ADDR|FIX'), unit: UNIT.addrFix,   qty: state.addrFixCount,  sum: UNIT.addrFix   * state.addrFixCount  });

        // OP
        if (state.optOmakaseOrder) items.push({ cat: 'OP', name: 'ãŠã¾ã‹ã›æ³¨æ–‡',         code: (singleMap['OP|OMAKASE']||'OP|OMAKASE'), unit: UNIT.omakase,    qty: 1, sum: UNIT.omakase });
        if (state.optCommentOnly)  items.push({ cat: 'OP', name: 'ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ãŠã¾ã‹ã›', code: (singleMap['OP|COMMENT']||'OP|COMMENT'), unit: UNIT.commentOnly, qty: 1, sum: UNIT.commentOnly });
        if (state.optLogo)         items.push({ cat: 'OP', name: 'ãƒ­ã‚´å…¥ã‚Œ',             code: (singleMap['OP|LOGO']||'OP|LOGO'),       unit: UNIT.logo,       qty: 1, sum: UNIT.logo });
        if (state.optProof)        items.push({ cat: 'OP', name: 'æ ¡æ­£ã‚µãƒ¼ãƒ“ã‚¹',         code: (singleMap['OP|PROOF']||'OP|PROOF'),     unit: UNIT.proof,      qty: 1, sum: UNIT.proof });
        if (state.optLogoCut)      items.push({ cat: 'OP', name: 'ãƒ­ã‚´åˆ‡ã‚ŠæŠœã',         code: (singleMap['OP|LOGOCUT']||'OP|LOGOCUT'), unit: UNIT.logoCut,    qty: 1, sum: UNIT.logoCut });
        if (state.optScanCount>0)  items.push({ cat: 'OP', name: 'ã‚¹ã‚­ãƒ£ãƒ³ã‚µãƒ¼ãƒ“ã‚¹',     code: (singleMap['OP|SCAN']||'OP|SCAN'),        unit: UNIT.scan,       qty: state.optScanCount, sum: UNIT.scan * state.optScanCount });

        // ã‚¯ãƒ¼ãƒãƒ³ï¼ˆãƒã‚¤ãƒŠã‚¹ï¼‰
        if (state.coupon>0)        items.push({ cat: 'å€¤å¼•', name: 'ã‚¯ãƒ¼ãƒãƒ³',            code: (singleMap[`COUPON|${Math.abs(state.coupon)}`]||`COUPON|${Math.abs(state.coupon)}`), unit: -state.coupon, qty: 1, sum: -state.coupon });

        // æç”»
        const tbody = document.getElementById('invBody');
        tbody.innerHTML = '';
        items.forEach(it => {
          const tr = document.createElement('tr');
          tr.className = 'border-b border-slate-100';
          const bcId = `bc_${Date.now()}_${Math.random().toString(36).slice(2)}`;
          tr.innerHTML = `
            <td class="px-3 py-2">${it.cat}</td>
            <td class="px-3 py-2">${it.name}</td>
            <td class="px-3 py-2">
              <div class="bc-box"><svg id="${bcId}"></svg></div>
              <div class="mt-1 text-[10px] text-slate-500">${String(it.code)}</div>
            </td>
            <td class="px-3 py-2 text-right">Â¥${yen(it.unit)}</td>
            <td class="px-3 py-2 text-right">${it.qty}</td>
            <td class="px-3 py-2 text-right">Â¥${yen(it.sum)}</td>
          `;
          tbody.appendChild(tr);
          renderBarcodeTo(document.getElementById(bcId), it.code);
        });

        const sumExcl = printPrice + opt.optionsTotal - state.coupon + dueAdd; // ã¯ãŒãä»£ã‚’é™¤ã
        document.getElementById('sumExclCard').textContent = `Â¥${yen(sumExcl)}`;
        document.getElementById('sumCardCost').textContent = `Â¥${yen(cardCost)}`;

        document.getElementById('invoice').classList.remove('hidden');
        document.getElementById('invoice').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      // ====== è¨ˆç®—ãƒœã‚¿ãƒ³ ======
      document.getElementById('btnCalc').addEventListener('click', () => {
        const err = document.getElementById('error');
        err.classList.add('hidden');
        err.textContent = '';

        const state = {
          artwork: document.getElementById('artwork').value,
          finish: document.getElementById('finish').value,
          cardType: document.getElementById('cardType').value,
          orderQty: toInt(document.getElementById('orderQty').value),
          bringInQty: toInt(document.getElementById('bringInQty').value),
          coupon: toInt(document.getElementById('coupon').value),
          superEarly: document.getElementById('superEarly').checked,
          early: document.getElementById('early').checked,
          addrDataCount: toInt(document.getElementById('addrDataCount').value),
          addrPaperCount: toInt(document.getElementById('addrPaperCount').value),
          addrFixCount: toInt(document.getElementById('addrFixCount').value),
          optOmakaseOrder: document.getElementById('optOmakaseOrder').checked,
          optCommentOnly: document.getElementById('optCommentOnly').checked,
          optLogo: document.getElementById('optLogo').checked,
          optProof: document.getElementById('optProof').checked,
          optLogoCut: document.getElementById('optLogoCut').checked,
          optScanCount: toInt(document.getElementById('optScanCount').value),
        };

        if (!state.finish) {
          err.textContent = "ä»•ä¸ŠãŒã‚Šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚";
          err.classList.remove('hidden');
          document.getElementById('result').classList.add('hidden');
          return;
        }
        if (state.orderQty <= 0) {
          err.textContent = "æ³¨æ–‡æšæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
          err.classList.remove('hidden');
          document.getElementById('result').classList.add('hidden');
          return;
        }
        if (state.bringInQty > state.orderQty) {
          err.textContent = "æŒè¾¼ã¯ãŒãã¯ã€æ³¨æ–‡æšæ•°ä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚";
          err.classList.remove('hidden');
          document.getElementById('result').classList.add('hidden');
          return;
        }

        const printPrice = calcPrintPrice(state.artwork, state.finish, state.orderQty, state.superEarly, state.early);
        const cardCost = calcCardCost(state.cardType, state.orderQty, state.bringInQty);
        const opt = calcOptions(state);
        const coupon = state.coupon;
        const baseTotal = Math.max(0, printPrice + cardCost + opt.optionsTotal - coupon);

        const head = document.getElementById('dueHead');
        const amt = document.getElementById('dueAmount');
        head.innerHTML = "";
        amt.innerHTML = "";

        const today = new Date();
        DUE_LABELS.forEach((l, idx) => {
          const d = addDays(today, l.offset);
          const th = document.createElement('th');
          th.className = "px-3 py-2 text-center align-bottom";
          th.innerHTML = `<div class="text-[14px] font-medium text-slate-700">${l.name}</div>
                          <div class="mt-0.5 text-xs text-slate-500">${fmtMD(d)}</div>`;
          head.appendChild(th);

          const td = document.createElement('td');
          td.className = "px-3 py-3 text-center text-[16px] font-semibold cursor-pointer hover:bg-slate-50 rounded";
          const totalWithDue = baseTotal + DUE_ADD[idx];
          td.textContent = `${yen(totalWithDue)} å††`;
          td.title = "ã‚¯ãƒªãƒƒã‚¯ã§æ–™é‡‘æ˜ç´°ã‚’è¡¨ç¤º";
          td.addEventListener('click', () => { renderInvoice(idx, state); });
          amt.appendChild(td);
        });

        const breakdown = document.getElementById('breakdown');
        breakdown.innerHTML = `
          <div class="flex flex-wrap items-center gap-3">
            <span class="pill">å°åˆ·ä»£: <b>Â¥${yen(printPrice)}</b></span>
            <span class="pill">ã¯ãŒãä»£: <b>Â¥${yen(cardCost)}</b></span>
            <span class="pill">å®›å: <b>Â¥${yen(opt.addr)}</b></span>
            <span class="pill">ãã®ä»–ã‚ªãƒ—ã‚·ãƒ§ãƒ³: <b>Â¥${yen(opt.checks + opt.scans)}</b></span>
            <span class="pill">ã‚¯ãƒ¼ãƒãƒ³: <b>âˆ’Â¥${yen(coupon)}</b></span>
            <span class="pill">å°è¨ˆ(ç´æœŸåŠ ç®—å‰): <b>Â¥${yen(baseTotal)}</b></span>
          </div>
        `;

        const invoiceEl = document.getElementById('invoice'); if (invoiceEl) invoiceEl.classList.add('hidden');
        document.getElementById('result').classList.remove('hidden');
      });

      // ====== ãƒãƒ¼ã‚³ãƒ¼ãƒ‰è¨­å®šï¼ˆå€‹åˆ¥ï¼‰ ======
      const dlg = document.getElementById('dlgBarcode');
      const txt = document.getElementById('barcodeJson');
      document.getElementById('btnBarcodeCfg').addEventListener('click', () => {
        txt.value = JSON.stringify(loadSingleMap(), null, 2);
        dlg.showModal();
      });
      document.getElementById('btnBarcodeSave').addEventListener('click', () => {
        try{
          const obj = JSON.parse(txt.value||'{}');
          for (const [k,v] of Object.entries(obj)){
            if (/^\d{8}$/.test(v) && !isValidEAN8(v)) {
              alert(`ã‚­ãƒ¼ã€Œ${k}ã€ã®ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã€Œ${v}ã€ã¯ EAN-8 ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
              return;
            }
          }
          saveSingleMap(obj);
          dlg.close();
        }catch(e){
          alert('JSONã®å½¢å¼ãŒä¸æ­£ã§ã™');
        }
      });
      document.getElementById('btnBarcodeReset').addEventListener('click', () => {
        localStorage.removeItem(LS_KEY_SINGLE);
        txt.value = JSON.stringify({}, null, 2);
      });

      // ====== ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç™»éŒ²ï¼ˆãƒšãƒ¼ã‚¸è²¼ä»˜ï¼‰ ======
      const dlgBulk = document.getElementById('dlgBulk');
      const bulkText = document.getElementById('bulkText');
      const bulkFinish = document.getElementById('bulkFinish');
      const bulkGrade = document.getElementById('bulkGrade');
      const bulkDisc = document.getElementById('bulkDisc');
      const bulkKeyPreview = document.getElementById('bulkKeyPreview');
      const bulkPreview = document.getElementById('bulkPreview');

      function updateBulkKeyPreview(){
        bulkKeyPreview.textContent = buildBulkKey(bulkGrade.value, bulkFinish.value, bulkDisc.value);
      }
      [bulkFinish, bulkGrade, bulkDisc].forEach(el=>el.addEventListener('change', updateBulkKeyPreview));
      updateBulkKeyPreview();

      document.getElementById('btnBarcodeBulk').addEventListener('click', () => {
        bulkText.value = '';
        bulkPreview.classList.add('hidden');
        updateBulkKeyPreview();
        dlgBulk.showModal();
      });

      document.getElementById('btnBulkSample').addEventListener('click', () => {
        bulkText.value = "68208202 68208301 68208400 68208509 68208608 68208707 68208806 68208905 68209001 68209100 68209209 68209308 68209407 68209506 68209605 68209704 68209803 68209902 68210007 68210106 68210205";
      });

      function parseBulkCodes(raw){
        const codes = (raw||'').match(/\d{8}/g) || [];
        let arr = codes.slice();
        if (arr.length === 22) arr = arr.slice(1); // 1æšåˆ†ã‚’é™¤å»
        if (arr.length < 21) return { ok:false, msg:`8æ¡ãŒ ${arr.length} å€‹ã§ã™ã€‚21å€‹å¿…è¦ã§ã™ï¼ˆ10ã€œ200, 201+ï¼‰ã€‚`, list:[] };
        if (arr.length > 21) arr = arr.slice(0,21);
        for (const c of arr){
          if (!isValidEAN8(c)) return { ok:false, msg:`EAN-8ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—: ${c}`, list:[] };
        }
        return { ok:true, msg:`OK: ${arr.length} å€‹ã‚’å–ã‚Šè¾¼ã¿ã¾ã™ã€‚`, list:arr };
      }

      document.getElementById('btnBulkParse').addEventListener('click', () => {
        const r = parseBulkCodes(bulkText.value);
        bulkPreview.classList.remove('hidden');
        if (!r.ok){
          bulkPreview.className = "mt-2 rounded-lg border border-red-200 bg-red-50 p-2 text-xs";
          bulkPreview.textContent = r.msg;
          return;
        }
        const lines = r.list.map((c,i)=> `${BANDS[i]}: ${c}`).join("\\n");
        bulkPreview.className = "mt-2 rounded-lg border border-slate-200 bg-slate-50 p-2 text-xs";
        bulkPreview.textContent = lines;
      });

      document.getElementById('btnBulkSave').addEventListener('click', () => {
        const r = parseBulkCodes(bulkText.value);
        if (!r.ok){ alert(r.msg); return; }
        const key = buildBulkKey(bulkGrade.value, bulkFinish.value, bulkDisc.value);
        const obj = loadBulkMap();
        obj[key] = {};
        r.list.forEach((code, i) => { obj[key][BANDS[i]] = code; });
        saveBulkMap(obj);
        alert(`ä¿å­˜ã—ã¾ã—ãŸï¼š${key}`);
        dlgBulk.close();
      });

      // ====== è‡ªå·±ãƒ†ã‚¹ãƒˆï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼‰ ======
      (function runSelfTests(){
        try {
          console.group("SelfTests");
          console.assert(ceil10(12) === 20, 'ceil10(12) â†’ 20');
          console.assert(ceil10(39) === 40, 'ceil10(39) â†’ 40');
          console.assert(isValidEAN8('68208202') === true, 'EAN8 check 68208202');
          console.assert(calcPrintPrice('MY','print',10,false,false) === 2500, 'MY/print/10=2500');
          console.assert(calcPrintPrice('MY','print',60,false,false) === 2500 + 650*4 + 600*1, 'MY/print/60');
          console.assert(calcPrintPrice('MY','photo',30,false,false) === 2700 + 660*(3-1), 'MY/photo/30');
          console.log('All tests passed.');
          console.groupEnd();
        } catch(e){ console.error('SelfTests failed:', e); }
      })();
    </script>
  </body>
</html>
